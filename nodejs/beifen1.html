
<!DOCTYPE html>
<html>
  <head>
    <title>凌远平音乐厅</title>
    <style>
    *{
    padding: 0;
    margin: 0;
    box-sizing: border-box;
    }

    html,body {
    height: 100%;
    }

    body{
    font: 14px "Lucida Grande",Helvetica,Arial,sans-serif;
    background:#000;
    color:#fff;
    text-align: center;
    }
    header,
    .left,
    .right{
    position:absolute;
    }
    header{
    left:10px;
    top:10px;
    right:10px;
    height:150px;
    border:solid #fff 1px;
    }

    header h1{
    font-size: 40px;
    height:60px;
    line-height:60px;
    }

    .left{
    left:10px;
    top: 170px;
    bottom: 10px;
    width: 200px;
    border: solid 1px red;
    }

    .left ul {
    overflow: auto;
    /*list-style-type: none;*/
    height: 100%;
    }
    .left ul li {
    overflow: hidden;
    height: 30px;
    line-height:30px;
    cursor: pointer;
    }
    .left ul li.selected{
    color: green;
    }
    .right{
    left: 220px;
    right: 10px;
    top: 170px;
    bottom: 10px;
    border:solid 1px red;
    }
  </style>
  </head>
  <body>
    <header>
      <h1>凌远平音乐厅</h1>
      <p>
        音量<input id = "volume" type = "range" min = "0" max = "100"
        value = "60">
      </p>
    </header>
    <div class="left">
      <ul id="list">

          <li title = "DJ OKAWARI - Flower Dance.mp3" > DJ OKAWARI - Flower Dance.mp3 </li>

          <li title = "许嵩 - 有何不可.mp3" > 许嵩 - 有何不可.mp3 </li>

          <li title = "许嵩 - 梧桐灯.mp3" > 许嵩 - 梧桐灯.mp3 </li>

      </ul>
    </div>
    <div class="right" id="box"></div>
    <script type="text/javascript" >
    function $(s){
      return document.querySelectorAll(s);
    }


    var lis = $("#list li");

    for (var i=0;i<lis.length;i++){
      lis[i].onclick = function(){
         for(var j = 0; j<lis.length;j++){
           lis[j].className = "";
         }
         this.className = "selected";
         load("/media/"+this.title);
      }
    }


    var xhr = new XMLHttpRequest();
    var ac = new (window.AudioContext||window.webkitAudioContext)();
    var gainNode = ac[ac.createGain?"createGain":"createGainNode"]();
    gainNode.connect(ac.destination);

     var analyser = ac.createAnalyser();
     var size = 64;
     analyser.fftSize = size * 2;
     analyser.connect(gainNode);

    var source = null;

    var count = 0;

    var box = $("#box")[0];
    var height,width;
    var canvas = document.createElement("canvas");
    box.appendChild(canvas);
    var ctx = canvas.getContext("2d");

    function resize(){
      height = box.clientHeight;
      width = box.clientWidth;
      canvas.height = height;
      canvas.width = width;
      var line = ctx.createLinearGradient(0,0,0,height);
      line.addColorStop(0,"red");
      line.addColorStop(0.5,"yellow");
      line.addColorStop(1,"green");
      ctx.fillStyle = line;

    }
    resize();
    window.onresize  = resize;

    function draw(arr){
      ctx.clearRect(0,0,width,height);
      var w = width / size ;
      for(var i = 0 ; i < size ; i++){
        var h = arr[i] / 256 * height;
        ctx.fillRect(w*i,height-h,w*0.6,h);
      }
    }

    function load(url){
      var n = ++count;
      source && source[source.stop?"stop":"noteOff"]();
       xhr.abort();
       xhr.open("GET",url);
       xhr.responseType = "arraybuffer";
       xhr.onload = function(){
         if(n != count ) return;
        ac.decodeAudioData(xhr.response,function(buffer){
          if(n != count ) return;
          var bufferSource = ac.createBufferSource();
          bufferSource.buffer = buffer;
          bufferSource.connect(analyser);
          bufferSource[bufferSource.start?"start":"noteOn"](0);
          source = bufferSource;
          visualizer();
        },function(err){
          console.log(err);
        });
       };
       xhr.send();
    }


    function visualizer(){
      var arr = new Uint8Array(analyser.frequencyBinCount);
      requestAnimationFreame = window.requestAnimationFrame ||
                              window.webkitRequestAnimationFrame ||
                              window.mozRequestAnimationFrame;
      function v(){
        analyser.getByteFrequencyData(arr);
        console.log(arr);
        draw(arr);
        requestAnimationFreame(v);
      }
      requestAnimationFreame(v);
    }



    function changeVolume(percent){
      gainNode.gain.value = percent*percent;
    }

    $("#volume")[0].onchange = function(){
      changeVolume(this.value/this.max);
    }


    $("#volume")[0].onchange();

    </script>
  </body>
</html>
